name: SQL CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  ci-cd:
    runs-on: ubuntu-latest
    name: Run SQL CI/CD on Snowflake

    steps:
      # Step 1: Checkout repository
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Step 2: Verify SQL files exist
      - name: Verify SQL files
        run: |
          if ls *.sql 1> /dev/null 2>&1; then
            echo "SQL files found:"
            ls *.sql
          else
            echo "ERROR: No SQL files found!"
            exit 1
          fi

      # Step 3: Install SnowSQL (OFFICIAL installer)
      - name: Install SnowSQL
        run: |
          curl -O https://sfc-repo.snowflakecomputing.com/snowsql/bootstrap/1.2/linux_x86_64/snowsql-1.2.31-linux_x86_64.tar.gz
          tar -xzf snowsql-1.2.31-linux_x86_64.tar.gz
          sudo mkdir -p /usr/local/snowsql
          sudo mv snowsql-1.2.31-linux_x86_64/* /usr/local/snowsql
          sudo ln -s /usr/local/snowsql/snowsql /usr/local/bin/snowsql

      # Step 4: Verify SnowSQL installation
      - name: Verify SnowSQL
        run: |
          which snowsql
          snowsql -v

      # Step 5: Execute all SQL scripts
      - name: Execute SQL Scripts
        env:
          SNOWSQL_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
          SNOWSQL_USER: ${{ secrets.SNOWFLAKE_USER }}
          SNOWSQL_PWD: ${{ secrets.SNOWFLAKE_PWD }}
          SNOWSQL_ROLE: ${{ secrets.SNOWFLAKE_ROLE }}
          SNOWSQL_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
        run: |
          for sql_file in *.sql; do
            echo "Running $sql_file..."
            snowsql \
              -a "$SNOWSQL_ACCOUNT" \
              -u "$SNOWSQL_USER" \
              -p "$SNOWSQL_PWD" \
              -r "$SNOWSQL_ROLE" \
              -w "$SNOWSQL_WAREHOUSE" \
              -o exit_on_error=true \
              -f "$sql_file"
          done

      # Step 6: Deployment confirmation
      - name: Deployment Status
        run: echo "CI/CD pipeline completed successfully."
